"""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                   SEWS AUTOMOTIVE - GMAO MASTER 2026                         ‚ïë
‚ïë           D√âVELOPP√â PAR: OMAR BENHAMDANE | PFE PROFESSIONAL                  ‚ïë
‚ïë      FEATURES: MTBF/MTTR, EMAIL ALERTS, ARCHIVE, DESIGN BLEU MARINE          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
"""

from flask import Flask, render_template_string, request, redirect, url_for, flash, session, jsonify
from datetime import datetime
import sqlite3
import statistics
import hashlib
import smtplib
from email.mime.text import MIMEText

app = Flask(__name__)
app.secret_key = "SEWS_SECRET_KEY_2026_OMAR"
DATABASE = 'sews_gmao_final.db'

# ==================== 1. SECURITY & EMAIL LOGIC ====================

def hash_password(password):
    return hashlib.sha256(password.encode()).hexdigest()

def envoyer_alerte_email(machine, description):
    # Setup dial l-email (Badal had l-ma3loumat b dyalk)
    SENDER = "votre_email@gmail.com"
    RECEIVER = "manager_sews@gmail.com"
    APP_PASSWORD = "votre_app_password" # Code dyal 16 raqm mn Google Settings

    body = f"‚ö†Ô∏è ALERTE PANNE CRITIQUE\n\nMachine: {machine}\nDescription: {description}\nHeure: {datetime.now().strftime('%H:%M:%S')}"
    msg = MIMEText(body)
    msg['Subject'] = f"üö® URGENT: Panne sur {machine}"
    msg['From'] = SENDER
    msg['To'] = RECEIVER

    try:
        with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
            server.login(SENDER, APP_PASSWORD)
            server.sendmail(SENDER, RECEIVER, msg.as_string())
    except:
        pass # Ila makanch l-internet may-t-blokach l-programme

# ==================== 2. DATABASE & ARCHIVE ====================

def get_db():
    db = sqlite3.connect(DATABASE)
    db.row_factory = sqlite3.Row
    return db

def init_db():
    db = get_db()
    cursor = db.cursor()
    cursor.execute('CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT UNIQUE, password TEXT, role TEXT, nom_complet TEXT)')
    cursor.execute('CREATE TABLE IF NOT EXISTS archive_centrale (id INTEGER PRIMARY KEY AUTOINCREMENT, date_action TIMESTAMP DEFAULT CURRENT_TIMESTAMP, utilisateur TEXT, action TEXT, details TEXT)')
    cursor.execute('CREATE TABLE IF NOT EXISTS machines (id INTEGER PRIMARY KEY, nom TEXT, zone TEXT, statut TEXT)')
    cursor.execute('''CREATE TABLE IF NOT EXISTS interventions (
        id INTEGER PRIMARY KEY AUTOINCREMENT, machine_id INTEGER, description TEXT, 
        priorite TEXT, date_declaration TIMESTAMP, temps_arret INTEGER, statut TEXT DEFAULT "en_attente")''')
    
    # Check Admin
    cursor.execute("SELECT * FROM users WHERE username='admin'")
    if not cursor.fetchone():
        cursor.execute("INSERT INTO users (username, password, role, nom_complet) VALUES (?,?,?,?)",
                      ('admin', hash_password("admin123"), 'admin', 'Omar BENHAMDANE'))
        cursor.execute("INSERT INTO machines (nom, zone, statut) VALUES ('Komax A1', 'Atelier C√¢blage', 'operationnel')")
        cursor.execute("INSERT INTO machines (nom, zone, statut) VALUES ('Presse B2', 'Atelier Sertissage', 'operationnel')")
    db.commit()
    db.close()

init_db()

def logger_action(user, action, details):
    db = get_db()
    db.execute("INSERT INTO archive_centrale (utilisateur, action, details) VALUES (?, ?, ?)", (user, action, details))
    db.commit()
    db.close()

# ==================== 3. ROUTES ====================

@app.route('/')
def login_page():
    return render_template_string(LOGIN_UI)

@app.route('/login', methods=['POST'])
def do_login():
    user = request.form.get('username')
    pwd = hash_password(request.form.get('password'))
    db = get_db()
    res = db.execute("SELECT * FROM users WHERE username=? AND password=?", (user, pwd)).fetchone()
    if res:
        session['user'] = res['nom_complet']
        session['role'] = res['role']
        logger_action(res['nom_complet'], "Connexion", "Entr√©e au syst√®me")
        return redirect(url_for('dashboard'))
    flash("Identifiants incorrects", "danger")
    return redirect(url_for('login_page'))

@app.route('/dashboard')
def dashboard():
    if 'user' not in session: return redirect(url_for('login_page'))
    db = get_db()
    interventions = db.execute("SELECT i.*, m.nom as m_nom FROM interventions i JOIN machines m ON i.machine_id = m.id ORDER BY i.id DESC").fetchall()
    archives = db.execute("SELECT * FROM archive_centrale ORDER BY id DESC LIMIT 6").fetchall()
    machines = db.execute("SELECT * FROM machines").fetchall()
    
    # Simulation des KPIs
    kpi = {'mtbf': 142, 'mttr': 28, 'dispo': 97.4}
    db.close()
    return render_template_string(MAIN_UI, interventions=interventions, archives=archives, kpi=kpi, machines=machines)

@app.route('/declarer', methods=['POST'])
def declarer():
    m_id = request.form.get('machine_id')
    desc = request.form.get('description')
    prio = request.form.get('priorite')
    
    db = get_db()
    db.execute("INSERT INTO interventions (machine_id, description, priorite, date_declaration) VALUES (?, ?, ?, ?)", 
               (m_id, desc, prio, datetime.now().strftime('%Y-%m-%d %H:%M')))
    db.commit()
    
    m_nom = db.execute("SELECT nom FROM machines WHERE id=?", (m_id,)).fetchone()[0]
    
    if prio == "critique":
        envoyer_alerte_email(m_nom, desc)
        logger_action(session['user'], "ALERTE EMAIL", f"Email envoy√© pour la machine {m_nom}")
    
    logger_action(session['user'], "D√©claration Panne", f"Panne d√©clar√©e sur {m_nom}")
    db.close()
    flash("‚úÖ Panne enregistr√©e et Alerte envoy√©e !", "success")
    return redirect(url_for('dashboard'))

# ==================== 4. UI DESIGN (SEWS BLUE MARINE) ====================

MAIN_UI = '''
<!DOCTYPE html>
<html>
<head>
    <title>GMAO SEWS - MASTER</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --sews-blue: #002366; --sews-gold: #FFD700; --bg: #f4f6f9; }
        body { background: var(--bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background: var(--sews-blue); border-bottom: 5px solid var(--sews-gold); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .card-custom { border: none; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: 0.3s; }
        .card-custom:hover { transform: translateY(-5px); }
        .kpi-title { font-size: 0.8rem; text-transform: uppercase; color: #6c757d; font-weight: bold; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: var(--sews-blue); }
        .table-sews thead { background: var(--sews-blue); color: white; }
        .badge-critique { background: #dc3545; color: white; }
        .archive-item { border-left: 4px solid var(--sews-gold); background: white; padding: 10px; margin-bottom: 8px; border-radius: 5px; font-size: 0.8rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark p-3 sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand fw-bold">üåê SEWS AUTOMOTIVE - GMAO SYSTEM</span>
            <span class="text-white small">Session: <b>{{ session.user }}</b> | <a href="/" class="text-gold" style="color: var(--sews-gold)">D√©connexion</a></span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card card-custom p-3 text-center">
                    <div class="kpi-title">MTBF (Fiabilit√©)</div>
                    <div class="kpi-value">{{ kpi.mtbf }}h</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-custom p-3 text-center">
                    <div class="kpi-title">MTTR (R√©paration)</div>
                    <div class="kpi-value text-danger">{{ kpi.mttr }}m</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-custom p-3 text-center">
                    <div class="kpi-title">Disponibilit√©</div>
                    <div class="kpi-value text-success">{{ kpi.dispo }}%</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-custom p-2 bg-dark text-white text-center">
                    <small>STATUS USINE</small>
                    <div class="h4 text-warning mt-1">PRODUCTION ON</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card card-custom p-4 mb-4">
                    <h5 class="fw-bold mb-3" style="color: var(--sews-blue)">üö® Nouvelle D√©claration de Panne</h5>
                    <form action="/declarer" method="POST" class="row g-2">
                        <div class="col-md-4">
                            <select name="machine_id" class="form-select" required>
                                {% for m in machines %}
                                <option value="{{ m.id }}">{{ m.nom }} - {{ m.zone }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" name="description" class="form-control" placeholder="Description du probl√®me" required>
                        </div>
                        <div class="col-md-2">
                            <select name="priorite" class="form-select">
                                <option value="normale">Normale</option>
                                <option value="critique">Critique</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" style="background: var(--sews-blue)">Envoyer</button>
                        </div>
                    </form>
                </div>

                <div class="card card-custom p-4">
                    <h5 class="fw-bold mb-3">üõ†Ô∏è Historique des Interventions</h5>
                    <div class="table-responsive">
                        <table class="table table-hover table-sews">
                            <thead>
                                <tr><th>Machine</th><th>Description</th><th>Priorit√©</th><th>Date</th><th>Statut</th></tr>
                            </thead>
                            <tbody>
                                {% for i in interventions %}
                                <tr>
                                    <td><b>{{ i.m_nom }}</b></td>
                                    <td>{{ i.description }}</td>
                                    <td><span class="badge {% if i.priorite=='critique' %}badge-critique{% else %}bg-info{% endif %}">{{ i.priorite }}</span></td>
                                    <td><small>{{ i.date_declaration }}</small></td>
                                    <td><span class="text-warning fw-bold small">{{ i.statut }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-custom p-4 mb-4">
                    <h5 class="fw-bold mb-3">üìà Statistiques</h5>
                    <canvas id="myChart" height="200"></canvas>
                </div>
                <div class="card card-custom p-4">
                    <h5 class="fw-bold mb-3">üìú Archive Centrale (Logs)</h5>
                    {% for log in archives %}
                    <div class="archive-item shadow-sm">
                        <div class="d-flex justify-content-between">
                            <b>{{ log.utilisateur }}</b>
                            <span class="text-muted" style="font-size: 0.7rem;">{{ log.date_action }}</span>
                        </div>
                        <div class="text-primary mt-1">{{ log.action }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
        const ctx = document.getElementById('myChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['En cours', 'Termin√©es', 'Attente'],
                datasets: [{
                    data: [5, 12, 3],
                    backgroundColor: ['#FFD700', '#002366', '#dc3545']
                }]
            }
        });
    </script>
</body>
</html>
'''

LOGIN_UI = '''
<body style="background: var(--sews-blue); --sews-blue: #002366; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif;">
    <div style="background: white; padding: 40px; border-radius: 20px; width: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); border-bottom: 8px solid #FFD700;">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: var(--sews-blue); font-weight: 900; letter-spacing: -1px;">SEWS GMAO</h1>
            <p style="color: #666; font-size: 0.9rem;">Syst√®me de Maintenance Master v2026</p>
        </div>
        <form action="/login" method="POST">
            <div class="mb-3">
                <label class="form-label small fw-bold">UTILISATEUR</label>
                <input type="text" name="username" class="form-control" style="border-radius: 8px;" required>
            </div>
            <div class="mb-4">
                <label class="form-label small fw-bold">MOT DE PASSE</label>
                <input type="password" name="password" class="form-control" style="border-radius: 8px;" required>
            </div>
            <button type="submit" class="btn w-100 py-2 fw-bold" style="background: var(--sews-blue); color: white; border-radius: 8px;">ENTRER AU SYST√àME</button>
        </form>
        <div style="text-align: center; margin-top: 25px; font-size: 0.75rem; color: #999;">
            D√©velopp√© par <b>Omar BENHAMDANE</b>
        </div>
    </div>
</body>
'''

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)